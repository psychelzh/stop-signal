function stopsignal (subject_code)% ListenChar(2);if nargin<1, error('lacking of subjectID input'); endTask_Duration=ones(1,2);Task_Duration(1)=GetSecs;%%% get ready by deleting all variables and all feedback figures%%%%%% generate exponential distributiontype=1;% if type==1, tasktype='sm'; elseif type==2, tasktype='sv'; elseif type==3, tasktype='sw'; end% JitterType=input('Please enter jitter type(1:fixted; 2:jittered): ');JitterType=1;sess_code=1;%Seed random number generator%rand('state',sum(100*clock));ClockRandSeed(6);try    %get screen ready    pixelSize=32;    timeout=3;    % timeout for RT reading    %         scrn=max(Screen('screens')); % find last screen    scrn=0;    HideCursor;    w=Screen('OpenWindow',scrn,0);  % open a dark screen    ifi=Screen('GetFlipInterval',w); % flip interval    vbl=Screen('Flip',w);  %#ok    rect=Screen (w,'rect');    Priority(MaxPriority(w));   % raise priority for better timing    sqtrigger=zeros(100,100)+255;    textrigger=Screen('MakeTexture',w,sqtrigger);    black=BlackIndex(w);    white=WhiteIndex(w);    xcenter=rect(3)/2;    ycenter=rect(4)/2;    theFont='Arial';    %get positions ready    CircleSize=50;    CirclePosX=xcenter-CircleSize/2;    CirclePosY=ycenter+20;    circle=[rect(3)/2-30,rect(4)/2-15,rect(3)/2+30,rect(4)/2+45,]    ArrowSize=50;    ArrowPosX=xcenter-ArrowSize/2+7;    ArrowPosY=ycenter-20;    TextColor=255;        %%%%************** DEFINE PARAMS HERE *************    WAITTIME=1;    Step=50;    OCI=0.5;    arrow_duration=1;        % if JitterType==1, NBLOCKS=4; else NBLOCKS=4; end    NBLOCKS=4;        meanrt=zeros(1,NBLOCKS);    stoprate=zeros(1,NBLOCKS);    dimerrors=zeros(1,NBLOCKS);    LEFT=KbName('f'); % key 1    RIGHT=KbName('j'); % key 2        %%%% Setting up the sound stuff    % sound('open');    % pause(0.5)    % samp = 22254.545454;    % aud_stim = sin(1:0.25:1000);    % aud_delay = [];    % aud_padding = [ zeros(1, round(0.005*samp)) ];	%%% Padding lasts for 5ms    % aud_vec = [  aud_delay  aud_padding  aud_stim  0 ];	% Vector fed into SND    % 	sound(aud_vec,samp); %play sound to start    % The zero at the end prevents a click at the start    % of the next sound to be played. Suggested by Denis Pelli        %%%%%%%%%%%%%% Stimuli and Response on same matrix, pre-determined    % The first column is  trial number;    % The second column is block    % The third column is 0 = Go, 1 = NoGo; 2 is null, 3 is notrial (kluge, see opt_stop.m)    % The fourth column is 0=left, 1=right arrow; 2 is null    % The fifth column is ladder number (1-4);    % The sixth column is the value currently in "LadderX", corresponding to this...    % The seventh column is subject response (no response is 0);    % The eighth column is their reaction time    % The ninth column is time since beginning of trial    % The tenth column is ladder movement (-1 for down, +1 for up, 0 for N/A)        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    %%%%%%%%%%%%%%%%%%%%%%%%%% TRIAL PRESENTATION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    %         sq=imread('MateStop/new.jpg','jpg');  %%% instruction    %         tex=Screen('MakeTexture',w,sq);    %         Screen('DrawTexture',w,tex);    %         Screen('Flip',w);    %         KbReleaseWait;WaitTill('');    %         Screen('Flip',w);        sq=imread('MateStop/inst.jpg','jpg');  %%% instruction    tex=Screen('MakeTexture',w,sq);    Screen('DrawTexture',w,tex);    Screen('Flip',w);    KbReleaseWait;WaitTill({'f' 'j'});    Screen('Flip',w);            totalcnt=1;  % this is the overall counter        for block=1:NBLOCKS % change number of blocks                Screen( 'TextFont',w, theFont);        Screen('TextSize',w, 50);                %%%%%%%%%%%%%%%%%%%%%%%%% MAKES TRIAL SEQUENCE **********        %%% this code correctly creates 64 (actually 128 with null) trials such that in every 16 trials there is one of each staircase        %%%   type and the number of left and rightward button presses is equal every four trials.        NUMCHUNKS=1;                for  tc=1:NUMCHUNKS            for qblock=1:4                LadderOrder=randperm(4);                arrows = [1 1 0 0];                [p  rand_idx]=sort(rand(1,4));                arrows=arrows(rand_idx);                for st=1:4                    %there are 4 in each, one stop, three go                    mini = [1 arrows(1) LadderOrder(st); 0 arrows(2) 0; 0 arrows(3) 0; 0 arrows(4) 0;];                    [p  rand_idx]=sort(rand(1,4));                    mini=mini(rand_idx,:);                    start=(tc-1)*64+(qblock-1)*16+(st-1)*4+1;                    endof=(tc-1)*64+(qblock-1)*16+(st)*4;                    trialcode(start:endof,:)=mini;                end            end        end                %%%%%%%%%%%%%%%%%%% GETS STAIRCASE STUFF SET UP %%%%%%%%%%%%%%        if block==1,  %only sets this stuff up once                        if JitterType==1                                Ladder1=140;                Ladder2=180;                Ladder3=220;                Ladder4=260;                            else                Ladder1=SSDfifty-60;                Ladder2=SSDfifty-20;                Ladder3=SSDfifty+20;                Ladder4=SSDfifty+60;            end                        Ladder(1,1)=Ladder1;            Ladder(2,1)=Ladder2;            Ladder(3,1)=Ladder3;            Ladder(4,1)=Ladder4;                    else            Ladder(1,1)=Ladder1((block-1)*4+1);            Ladder(2,1)=Ladder2((block-1)*4+1);            Ladder(3,1)=Ladder3((block-1)*4+1);            Ladder(4,1)=Ladder4((block-1)*4+1);        end                        %%%%%%%%%%%%%%%%%%% PREPARES 'SEEKER' VARIABLE IN WHICH DATA ARE SAVED %%%%%%%%%%%%%%                %%% Seeker will be number of blocks*64        %%% this code take trialcode, which is 64 rows long and newly generated for each block, and appends it        %%% the ladder variable is filled in with the current relevant value even though this will change later                for  trlcnt=1:64                                                                     %go/nogo        arrow              staircase        staircase value            if trialcode(trlcnt,3)>0, Seeker((block-1)*64+trlcnt,:) = [trlcnt block  trialcode(trlcnt,1) trialcode(trlcnt,2) trialcode(trlcnt,3) Ladder(trialcode(trlcnt,3)) 0 0 0 0];            else Seeker((block-1)*64+trlcnt,:) =                      [trlcnt block  trialcode(trlcnt,1) trialcode(trlcnt,2) trialcode(trlcnt,3) 0 0 0 0 0];            end        end                %%%% load prescan_wordlist 1 or 2, 3 4, 5, 6, 10;        % if scannum==1, load wordlist1.mat, else load wordlist2.mat; end                %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                anchor=GetSecs;                for a=1:4, %4 miniblocks            for b=1:16, % within each miniblock                                Screen('FrameOval', w, 255, circle, 4);                fixtime=Screen('Flip',w);                WaitTill(GetSecs+ 0.5);                if (Seeker(totalcnt,4)==0),                    Screen('FrameOval', w, 255, circle, 4);                    DrawFormattedText(w, '<', ArrowPosX, ArrowPosY, [255 255 255]);                else                    Screen('FrameOval', w, 255, circle, 4);                    DrawFormattedText(w, '>', ArrowPosX, ArrowPosY, [255 255 255]); %, [], 0, 0, 2                end;                start_time=Screen('Flip',w);                                noresp=1;                notone=1;                FlushEvents('keyDown');                                %%% the while loop only exits when arrow duration time is up OR a button is pressed                WaitSecs(0.1);                                while(GetSecs-start_time < arrow_duration & noresp) | (Seeker(totalcnt,3)==1 & notone),                                        % stop trialSSD                    % 	     if Seeker(totalcnt,3)==1 & GetSecs - start_time >=Seeker(totalcnt,6)/1000 & notone,                    % 		    sound(aud_vec,samp);                    % 		    notone=0;                    %          end                                        % new stopsignal                    if Seeker(totalcnt,3)==1 & GetSecs - start_time >=Seeker(totalcnt,6)/1000 & notone,                        Screen('FrameOval', w, [255 0 0], circle, 4);                        if (Seeker(totalcnt,4)==0),                            DrawFormattedText(w, '<', ArrowPosX, ArrowPosY, [255 255 255]);                        else                            DrawFormattedText(w, '>', ArrowPosX, ArrowPosY, [255 255 255]); %, [], 0, 0, 2                        end;                        start_time=Screen('Flip',w);                        notone=0;                    end                                        %                    %                 if type==1 %i.e. manual                    [keyIsDown,secs,keyCode] = KbCheck;                    if keyIsDown                        if find(keyCode) == KbName('q'), screen('closeall'); ActiveWire(1,'CloseDevice'); return; end                        if find(keyCode)==LEFT | find(keyCode)==RIGHT                            Seeker(totalcnt,7)=find(keyCode);                            Seeker(totalcnt,8)=GetSecs-start_time;                            noresp=0;                        end                    end                                        %                 elseif (type==2 | type==3)                    %                     [keyIsDown,secs,keyCode] = KbCheck;                    %                     if keyIsDown                    %                         if find(keyCode) == KbName('q'), screen('closeall'); activwire(1,'CloseDevice'); return; end                    %                     end                    %                     portvalue=ones(1,16);                    %                     portvalue = activewire(1,'GetPort');                    %                     if isempty(find(portvalue==0)), noresp=0;                    %                         Seeker(totalcnt,8)=GetSecs-start_time;                    %                         Seeker(totalcnt,7)=1;                    %                     end;                    %                 end % end if, elseif                                    end    %end while                Screen('Flip',w); %                                                %%% punish subject for making an error                if Seeker(totalcnt,3)==0 & noresp                    xword='请在1秒内按键';                    DrawFormattedText(w, xword, 'center', 'center', 255);                    Screen('Flip',w);                    pause(0.5);                    Screen('Flip',w);                end                                if Seeker(totalcnt,3)==0 & ( (Seeker(totalcnt,4)==0 & Seeker(totalcnt,7)==RIGHT) | ( Seeker(totalcnt,4)==1 & Seeker(totalcnt,7)==LEFT ) )                    %           SCREEN('TextSize',w,  50);                    xword='错了！';                    xword=double(xword);                    Screen('DrawText',w, xword, xcenter-100, ycenter+50,255);                    Screen('Flip',w);                    WaitTill(GetSecs+2);                    Screen('Flip',w);                end                                WaitTill(GetSecs+WAITTIME);                                Seeker(totalcnt,9)=GetSecs-anchor; %absolute time since beginning of block                totalcnt = totalcnt +1; %%% this update the overall counter                            end; % end of trial loop;                        % after each 16 trials this code does the updating of staircases            %These three loops update each of the ladders            for c=(totalcnt-16):totalcnt-1,  %this looks at the last 16 trials                %This runs from one to four, one for each of the ladders                for d=1:4,                                        if (Seeker(c,7)~=0 & Seeker(c,5)==d),	%col 7 is sub response                        Ladder(d,1)=Ladder(d,1)-Step;                        Ladder(d,2)=-1;                        if (d==1),                            [x y]=size(Ladder1);                            Ladder1(x+1,1)=Ladder(d,1);                        elseif (d==2),                            [x y]=size(Ladder2);                            Ladder2(x+1,1)=Ladder(d,1);                        elseif (d==3),                            [x y]=size(Ladder3);                            Ladder3(x+1,1)=Ladder(d,1);                        elseif (d==4),                            [x y]=size(Ladder4);                            Ladder4(x+1,1)=Ladder(d,1);                        end;                    elseif (Seeker(c,5)==d & Seeker(c,7)==0),                        Ladder(d,1)=Ladder(d,1)+Step;                        Ladder(d,2)=1;                        if (d==1),                            [x y]=size(Ladder1);                            Ladder1(x+1,1)=Ladder(d,1);                        elseif (d==2),                            [x y]=size(Ladder2);                            Ladder2(x+1,1)=Ladder(d,1);                        elseif (d==3),                            [x y]=size(Ladder3);                            Ladder3(x+1,1)=Ladder(d,1);                        elseif (d==4),                            [x y]=size(Ladder4);                            Ladder4(x+1,1)=Ladder(d,1);                        end;                    end; % end elseif                end; % end for d=1:4            end; % end for c=...                        %Updates the time in each of the subsequent stop trials            for c=totalcnt:(block-1)*64+64,                if (Seeker(c,5)~=0), %i.e. staircase trial                    Seeker(c,6)=Ladder(Seeker(c,5),1);                end;            end;            %Updates each of the old trials with a +1 or a -1 (in col 10)            for c=(totalcnt-16):totalcnt-1,                if (Seeker(c,5)~=0),                    Seeker(c,10)=Ladder(Seeker(c,5),2);                end;            end;                    end; %end of miniblock                %%%% FEEDBACK %%%%%                %  block      		  go           response        if type==1            meanrt(block) = 1000*median(Seeker(find( Seeker(:,2)==block & Seeker(:,3)==0 & Seeker(:,7)~=0  & ( (Seeker(:,4)==1 & Seeker(:,7)==RIGHT) | ( Seeker(:,4)==0 & Seeker(:,7)==LEFT ) )),8));            dimerrors(block)=sum((Seeker(:,2)==block & Seeker(:,3)==0 & ( (Seeker(:,4)==0 & Seeker(:,7)==RIGHT) | ( Seeker(:,4)==1 & Seeker(:,7)==LEFT ) )));            stoprate(block)=length(find(Seeker(:,2)==block & Seeker(:,10)==1))/16        else            meanrt(block) = 1000*median(Seeker(find( Seeker(:,2)==block & Seeker(:,3)==0 & Seeker(:,8)>0),8));        end                        %make new feedback figure for each block        xvals=1:1:NBLOCKS;        fh=figure        subplot(2,1,1);        plot(xvals,meanrt,'.','markersize',30);        axis([1 NBLOCKS 100 900]);        title('按键平均反应时(ms)')        if type==1            subplot(2,1,2);            %    plot(xvals,dimerrors,'.','markersize',30);            plot(xvals,stoprate,'.','markersize',30);            axis([1 NBLOCKS 0 1]);            title('Stop Rate')        end                fname = sprintf('Results/feedbackpic%dsub%d.jpg',block,subject_code);        print(fh,'-djpeg', '-r100', fname);        close(fh);        %    fbimage = {imread(fname, 'jpg')};        fbimage = imread(fname, 'jpg');        tex=Screen('MakeTexture',w,fbimage);        Screen('DrawTexture',w,tex);        DrawFormattedText(w, '按键继续...', 'center', rect(4)*0.9, [255 0 0]);        Screen('Flip',w);        KbReleaseWait;WaitTill('');        Screen('Flip',w);            end; %end block loop        Task_Duration(2)=GetSecs-Task_Duration(1);    c=clock;    outfile=sprintf('Results/StopSignal_Sub%03d_%s_%02.0f_%02.0f.mat',subject_code,date,c(4),c(5))    save(outfile, 'Seeker','Task_Duration');        % ladder for feedback    stopsignalAnalysis(Seeker)        %     sq=imread('HaveaRest.jpg','jpg');    %     tex=Screen('MakeTexture',w,sq);    %     Screen('DrawTexture',w,tex);    str=sprintf('本任务结束,按键退出')    DrawFormattedText(w, str, 'center', 'center', 255,0, 0, 0, 2);        Screen('Flip',w);    KbReleaseWait;WaitTill({'f' 'j'});%    Task.startTime =t;    Screen('Flip',w);    catch    c=clock;    outfile=sprintf('Results/Temp_StopSignal_Sub%03d_%s_%02.0f_%02.0f.mat',subject_code,date,c(4),c(5))    save(outfile, 'Seeker','Task_Duration');    Screen('CloseAll'); Priority(0);    rethrow(lasterror);    %     ListenChar(0);endScreen('CloseAll');Priority(0);                % restore normal priority% ListenChar(0);%%%% FEEDBACK %%%%%sound('close');% c=clock;% d=date;% folder = fileparts(which(mfilename));% outfile=sprintf('%s\\%d\\StopSignal_%d_%s_%02.0f-%02.0f',folder,subject_code,subject_code, d(1:6),c(4),c(5));% save(outfile, 'seeker');